<!DOCTYPE>
<html lang="en">
<head>
    <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Free HTML5 Bootstrap Admin Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Charisma, a fully featured, responsive, HTML5, Bootstrap admin template.">
    <meta name="author" content="Muhammad Usman">

    <!-- The styles -->
    <link href="../../css/bootstrap-11.min.css" rel="stylesheet">
    <link href="../../css/charisma-app.css" rel="stylesheet">
    <link href='../../css/chosen.min.css' rel='stylesheet'>
    <link href='../../css/colorbox.css' rel='stylesheet'>
    <link href='../../css/responsive-tables.css' rel='stylesheet'>
    <link href='../../css/bootstrap-tour.min.css' rel='stylesheet'>
    <link href='../../css/jquery.noty.css' rel='stylesheet'>
    <link href='../../css/noty_theme_default.css' rel='stylesheet'>
    <link href='../../css/elfinder.min.css' rel='stylesheet'>
    <link href='../../css/elfinder.theme.css' rel='stylesheet'>
    <link href='../../css/jquery.iphone.toggle.css' rel='stylesheet'>
    <link href='../../css/uploadify.css' rel='stylesheet'>
    <link href='../../css/animate.min.css' rel='stylesheet'>
    <link href='../../css/bootstrap-datetimepicker.css' rel='stylesheet'>
    <link rel="stylesheet"  href="../../css/icheck/yellow.css"/>
    <link rel="stylesheet"  href="../../css/button.css"/>
    <link rel="stylesheet"  href="../../css/common.css"/>

    <!-- jQuery -->
	<script type="text/javascript" src="../../js/lib/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="../../js/lib/jquery/plugins/jquery.string.js"></script>
	<script type="text/javascript" src="../../js/lib/jquery/plugins/jquery.json.js"></script>
	<script type="text/javascript" src="../../js/lib/easyui/plugins/jquery.draggable.js"></script>
	<script type="text/javascript" src="../../js/lib/easyui/plugins/jquery.parser.js"></script>
    <script type="text/javascript" src="../../../js/peripheral.js"></script>
	<script type="text/javascript" src="../../js/map.js"></script>
	<script src="../../js/lib/jquery/icheck/jquery.icheck.js" type="text/javascript" ></script>
 
    <!-- The fav icon -->
    <link rel="shortcut icon" href="../../images/favicon.ico">
    

</head>

<body>
<div id="loading1">
	<div>
		<image src='../../js/lib/easyui/themes/default/images/loading.gif' />  正在处理，请稍等...
	</div>
</div>
<div id="loading2">
		<div>
			<image src='../../js/lib/easyui/themes/default/images/loading.gif' />  正在刷新，请稍等...
		</div>
</div>
<div class="ch-container" id="container" style="display: none;">
	<form id= "frm">
    <div class="row" >
        
        <noscript>
            <div class="alert alert-block col-md-12">
                <h4 class="alert-heading">Warning!</h4>
            </div>
        </noscript>

    <div id="content" class="col-lg-12 col-sm-12">
            <!-- content starts -->
	<div class="row">
        <div class="box col-md-12">
            <div class="box-inner">
                <div class="box-header well">
                    <h2><i class="glyphicon glyphicon-info-sign"></i>取号机与叫号机通讯设置</h2>

                    <div class="box-icon">
                        <a href="#" class="btn btn-minimize btn-round btn-default"><i
                                class="glyphicon glyphicon-chevron-up"></i></a>
                    </div>
                </div>
                <div class="box-content">
                <table class="table table-bordered responsive">
                     
                        <tbody>
							<tr>
								<td  class="td-right">
									<div class="form-label">叫号终端地址<em>* </em></div>
								</td>
								<td>
									<div class="ipWidget">
											<input type="text" name="ipOne" id="ipOne" maxlength="3" onkeyup="return t1_onkeyup()">
											<input type="text" name="ipTwo" id="ipTwo" maxlength="3" onkeyup="return t2_onkeyup()">
											<input type="text" name="ipThr" id="ipThr" maxlength="3" onkeyup="return t3_onkeyup()">
											<input type="text" name="ipFour" id="ipFour" maxlength="3">
									</div>
								</td>

							</tr>
							<tr>
								<td  class="td-right">
									叫号终端端口<em>* </em>
								</td>
								<td >
									<div class="controls">
										<input type="text" id="port" name="port" class="form-control"  placeholder="请输入叫号机端口" maxlength="10" />
									</div>
								</td>								
							</tr>
							<tr>
								<td class="td-right">
									<div class="form-label">超时时间(毫秒)<em>* </em></div>
								</td>
								<td >
									<div class="controls">
										<input type="text" id="timeout" name="timeout" class="form-control"  placeholder="请输入超时时间" maxlength="10" />
									</div>
								</td>
							</tr>							
                        </tbody>
                    </table>
               </div>
            </div>
        </div>
        <!--/span-->
    </div><!--/row-->
   
	<div class="row">
        <div class="box col-md-12">
            <div class="box-inner">
                <div class="box-header well">
                    <h2><i class="glyphicon glyphicon-info-sign"></i>综合管理</h2>

                    <div class="box-icon">
                        <a href="#" class="btn btn-minimize btn-round btn-default"><i
                                class="glyphicon glyphicon-chevron-up"></i></a>
                    </div>
                </div>
                <div class="box-content">
                <table class="table table-bordered responsive">
                        <tbody>
							<tr>
								<td class="td-right">
									
								</td>
								<td >
									<div class="controls">
										<input id="boxRestart"  style="float: left" type="button" class="btn btn-primary" value="叫号机重启">
									</div>
								</td>							
							</tr>
							<tr>
								<td class="td-right">
									
								</td>
								<td >
									<div class="controls">
										<input id="qmsRestart"  style="float: left" type="button" class="btn btn-primary" value="取号机重启">
									</div>
								</td>							
							</tr>
                        </tbody>
                    </table>
               </div>
            </div>
        </div>
        <!--/span-->
    </div><!--/row-->
    
	<div class="row">
        <div class="box col-md-12">
            <div class="box-inner">
                <div class="box-header well">
                    <h2><i class="glyphicon glyphicon-info-sign"></i>取号机日志管理</h2>

                    <div class="box-icon">
                        <a href="#" class="btn btn-minimize btn-round btn-default"><i
                                class="glyphicon glyphicon-chevron-up"></i></a>
                    </div>
                </div>
                <div class="box-content">
                <table class="table table-bordered responsive">
                        <tbody>
							<tr>
								<td class="td-right">
									
								</td>
								<td >
									<div class="controls">
										<input id="openQmsLog"  style="float: left" type="button" class="btn btn-primary cleanButton" value="查看取号机日志">
									</div>
								</td>							
							</tr>							
                        </tbody>
                    </table>
               </div>
            </div>
        </div>
        <!--/span-->
    </div><!--/row-->
    
	<div class="row">
        <div class="box col-md-12">
            <div class="box-inner">
                <div class="box-header well">
                    <h2><i class="glyphicon glyphicon-info-sign"></i>叫号机日志管理</h2>

                    <div class="box-icon">
                        <a href="#" class="btn btn-minimize btn-round btn-default"><i
                                class="glyphicon glyphicon-chevron-up"></i></a>
                    </div>
                </div>
                <div class="box-content">
                <table class="table table-bordered responsive">                    
                        <tbody>
							<tr>
								<td class="td-right">
									<div class="form-label">起始日期<em>*</em></div>
								</td>
								<td >
									<input type="text" id="beginDate" name="beginDate" class="form_datetime dataStyle" readonly="readonly" />
								</td>							
							</tr>
							<tr>
								<td class="td-right">
									<div class="form-label">终止日期<em>*</em></div>
								</td>
								<td >
									<input type="text" id="endDate" name="endDate" class="form_datetime dataStyle " readonly="readonly" />
								</td>
							</tr>
							<tr>
								<td class="td-right">
									
								</td>
								<td >
									<div class="controls">
										<input  style="float: left" type="button" class="btn btn-primary cleanButton" id="cleanFiv" onclick="downloadLog()" value="下载日志">
									</div>
								</td>							
							</tr>
							<tr>
								<td class="td-right">
									
								</td>
								<td >
									<div class="controls">
										<input id="openBoxLog"  style="float: left" type="button" class="btn btn-primary cleanButton" id="cleanFiv" value="查看叫号机日志">
									</div>
								</td>
							</tr>							
                        </tbody>
                    </table>
               </div>
            </div>
        </div>
        <!--/span-->
    </div><!--/row-->
    
    <!-- content ends -->
    </div><!--/#content.col-md-0-->
</div><!--/fluid-row-->
    <div class="row">
        <div class="box col-md-12">
            <div class="box-inner">
                <div class="box-content">
                	<p class="center" style="margin-bottom: 0px;">
						<input type="submit" class="btn btn-primary btn-custom btn-custom" id="saveConfig" value="保存">						
					</p>
					
               </div>
            </div>
        </div>
        <!--/span-->
    </div><!--/row-->
</form>
</div><!--/.fluid-container-->

<!-- external javascript -->

<script src="../../js/bootstrap.min.js"></script>

<!-- library for cookie management -->
<script src="../../js/jquery.cookie.js"></script>
<!-- data table plugin -->
<script src='../../js/jquery.dataTables.min.js'></script>

<!-- select or dropdown enhancer -->
<script src="../../js/chosen.jquery.min.js"></script>
<!-- plugin for gallery image view -->
<script src="../../js/jquery.colorbox-min.js"></script>
<!-- notification plugin -->
<script src="../../js/jquery.noty.js"></script>
<!-- library for making tables responsive -->
<script src="../../js/responsive-tables.js"></script>
<!-- tour plugin -->
<script src="../../js/bootstrap-tour.min.js"></script>
<!-- star rating plugin -->
<script src="../../js/jquery.raty.min.js"></script>
<!-- for iOS style toggle switch -->
<script src="../../js/jquery.iphone.toggle.js"></script>
<!-- autogrowing textarea plugin -->
<script src="../../js/jquery.autogrow-textarea.js"></script>
<!-- multiple file upload plugin -->
<script src="../../js/jquery.uploadify-3.1.min.js"></script>
<!-- history.js for cross-browser state change on ajax -->
<script src="../../js/jquery.history.js"></script>
<!-- application script for Charisma demo -->
<script src="../../js/charisma.js"></script>
<script type="text/javascript" src="../../js/jquery.metadata.js"></script>
<script type="text/javascript" src="../../js/jquery.validate.min.js"></script>
<script type="text/javascript" src="../../js/messages_zh.js"></script>
<script type="text/javascript" src="../../js/qmsVld.js"></script>
<script type="text/javascript" src="../../js/bootbox.js"></script>
<script type="text/javascript" src="../../../js/lib/date/bootstrap-datetimepicker.js"></script>
<script type="text/javascript" src="../../../js/lib/date/bootstrap-datetimepicker.zh-CN.js"></script>

<script type="text/javascript">
$(function(){
	//向壳查询信息并解析（同步方法）
	var jo = $.qms.selectWebServer();
	var joResult = $.parseJSON(jo);
	if(joResult){
		$("#ipOne").val("");
		$("#ipTwo").val("");
		$("#ipThr").val("");
		$("#ipFour").val("");
		$("#port").val("");
		$("#timeout").val("");
		
		var retCode = joResult.biom.head.retCode;
		var retMsg = joResult.biom.head.retMsg;
		if(retCode == "1"){
			window.location.href = "timeout.html?retMsg="+retMsg;
		}
		var host = joResult.biom.body.host;
		var hostTemp = host.split(".");
		$("#ipOne").val(hostTemp[0]);
		$("#ipTwo").val(hostTemp[1]);
		$("#ipThr").val(hostTemp[2]);
		$("#ipFour").val(hostTemp[3]);
		$("#port").val(joResult.biom.body.port);
		$("#timeout").val(joResult.biom.body.timeout);
	}
	//关闭遮罩
	closeLoading();
	$("#container").css("display","block");
	//重启叫号机
	$("#boxRestart").on("click",function(){
		bootbox.setLocale("zh_CN");
      	bootbox.confirm("确定重启?", function(result) {
	        if (result) {
	        	//开启遮罩
	        	$("#container").css("opacity","0.3");
	        	$("#loading2").css("display","block");
	        	
		    	args = {};
		    	args.biom = {};
		    	args.biom.head = {};
		    	args.biom.head.tradeCode = "boxRestart";
		    	args.biom.head.qmsIp = $.qms.getCache("qmsIp");
		    	args.biom.body = {};
		    	args.callback="boxRestartCallBack";
		    	//alert($.toJSON(args));
		    	$.icbcQms.boxRestartService(args);
	        }  
      	});
	});	
	//取号机重启
	$("#qmsRestart").on("click",function(){
		bootbox.setLocale("zh_CN");
      	bootbox.confirm("确定重启?", function(result) {
	        if (result) {
	        	//开启遮罩
	        	$("#container").css("opacity","0.3");
	        	$("#loading2").css("display","block");
	        	
		    	$.qms.qmsRestart();
		    	
		    	//关闭遮罩
	        	$("#container").css("opacity","1");
	        	$("#loading2").css("display","none");
	        }  
      	});
	});
	//打开取号机日志
	$("#openQmsLog").on("click",function(){
		$.qms.openQmsLog();
	});
	//打开叫号机日志
	$("#openBoxLog").on("click",function(){
		$.qms.openBoxLog();
	});
	$("input[name='beginDate']").datetimepicker({
		format: 'yyyy-mm-dd',　　
		language: 'zh-CN',
		startView:2,
		autoclose:true,
		todayHighlight:true,
		minView:2,
		todayBtn:true
	});
	$("input[name='endDate']").datetimepicker({
		format: 'yyyy-mm-dd',　　
		language: 'zh-CN',
		startView:2,
		autoclose:true,
		todayHighlight:true,
		minView:2,
		todayBtn:true
	});
});
function boxRestartCallBack(args){
	//关闭遮罩
	$("#container").css("opacity","1");
    $("#loading2").css("display","none");
    
    var joResult = $.parseJSON(args);
    if(joResult){
    	if(joResult.biom.head.retCode == 0){
			qmsVld.showInfo(joResult.biom.head.retMsg);
		}else{
			qmsVld.showError(joResult.biom.head.retMsg);
		}
    }
}
//ip填写控件
function t1_onkeyup() {
  if($("#ipOne").val().length == 3){
    	$("#ipTwo").focus();
   }
} 
function t2_onkeyup() {
  if($("#ipTwo").val().length == 3){
    	$("#ipThr").focus();
   }
}
function t3_onkeyup() {
  if($("#ipThr").val().length == 3){
    	$("#ipFour").focus();
   }
}
//保存（同步方法）
$("#frm").validate({
	rules: {		
		ipOne:{required:true,ipPart:true},
		ipTwo:{required:true,ipPart:true},
		ipThr:{required:true,ipPart:true},
		ipFour:{required:true,ipPart:true},
		port:{required:true,num:true},
		timeout:{required:true,num:true}
	},	
	onfocusout: function(element) { 
		$(element).valid(); 
	},		
	submitHandler: function(form){
		saveConfig();
		return false;
	}
});
function saveConfig(){
	var ipOne = $.trim($("#ipOne").val());
	var ipTwo = $.trim($("#ipTwo").val());
	var ipThr = $.trim($("#ipThr").val());
	var ipFour = $.trim($("#ipFour").val());
	var host = ipOne+"."+ipTwo+"."+ipThr+"."+ipFour;
	var port = $.trim($("#port").val());
	var timeout = $.trim($("#timeout").val());
	
	var args = {};
	args.biom = {};
	args.biom.head = {};
	args.biom.head.tradeCode = "localhostqmsconfig2select";
	args.biom.head.qmsIp = "127.0.0.1";
	args.biom.body = {};
	args.biom.body.host = host;
	args.biom.body.port = port;
	args.biom.body.timeout = timeout;
	//alert($.toJSON(args));
	var flag = $.qms.updateWebServer($.toJSON(args));
	if(flag){
		qmsVld.showInfo("保存成功!");
	} else{
		qmsVld.showInfo("保存失败!");
	}
}
//-------------日志部分
function downloadLog(){
	
	  //读取数据
	  var beginDate = $.trim($("#beginDate").val());
	  var endDate = $.trim($("#endDate").val());
	  var beginDateTemp = Date.parse(beginDate.replace(/-/g,"/"));
	  var endDateTemp = Date.parse(endDate.replace(/-/g,"/"));
	  //alert("s:"+beginDateTemp+"|"+"e:"+endDateTemp+"|");
	  var time = (endDateTemp-beginDateTemp)/(3600*24*1000);
	  if(beginDate == "" || endDate == ""){
	  	bootbox.alert("起始日期、终止日期不能为空，请填写!");
	  	$(".modal-content .modal-footer .btn").text("");
	  	$(".modal-content .modal-footer .btn").text("确定");
	  } else if(beginDateTemp > endDateTemp){
	  	  bootbox.alert("起始日期不能大于终止日期，请重新填写!");
	  	  $(".modal-content .modal-footer .btn").text("");
	  	  $(".modal-content .modal-footer .btn").text("确定");
	  } else if(time > 30){
	  	  bootbox.alert("时间间隔超过30天，请重新填写!");
	  	  $(".modal-content .modal-footer .btn").text("");
	  	  $(".modal-content .modal-footer .btn").text("确定");
	  }else{
		  //开启遮罩
		  $("#loading2").css("display","block");
		  $("#container").css("opacity","0.3");
		  //发送查询叫号机日志报文
		  var args = {};
		  args.biom = {};
		  args.biom.head = {};
		  args.biom.head.tradeCode = "logquery";
		  args.biom.head.qmsIp = $.qms.getCache("qmsIp");//;
		  args.biom.body = {};
		  args.biom.body.beginDate = beginDate;
		  args.biom.body.endDate = endDate;
		  args.callback="getLogQueryCallBack";
		  $("#loading2").css("display","block");
		  //alert($.toJSON(args));
		  $.icbcQms.getLogQuery2JS(args);
	  }
}

function getLogQueryCallBack(args){
	//alert(args);
	//关闭遮罩
	$("#loading2").css("display","none");
	$("#container").css("opacity","1");
	//处理叫号机返回报文
	var joResult = $.parseJSON(args);
	if(joResult){
		if(joResult.biom.head.retCode == 0){
			qmsVld.showInfo(joResult.biom.head.retMsg);
		}else{
			qmsVld.showError(joResult.biom.head.retMsg);
		}				
	}
}
</script>



</body>
</html>
