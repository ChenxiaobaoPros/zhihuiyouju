<!DOCTYPE>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Free HTML5 Bootstrap Admin Template</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Charisma, a fully featured, responsive, HTML5, Bootstrap admin template.">
    <meta name="author" content="Muhammad Usman">

    <!-- The styles -->
    <link id="bs-css" href="../../css/bootstrap-11.min.css" rel="stylesheet">
    <link href="../../css/charisma-app.css" rel="stylesheet">
    <link href='../../css/chosen.min.css' rel='stylesheet'>
    <link href='../../css/colorbox.css' rel='stylesheet'>
    <link href='../../css/responsive-tables.css' rel='stylesheet'>
    <link href='../../css/bootstrap-tour.min.css' rel='stylesheet'>
    <link href='../../css/jquery.noty.css' rel='stylesheet'>
    <link href='../../css/noty_theme_default.css' rel='stylesheet'>
    <link href='../../css/elfinder.min.css' rel='stylesheet'>
    <link href='../../css/elfinder.theme.css' rel='stylesheet'>
    <link href='../../css/jquery.iphone.toggle.css' rel='stylesheet'>
    <link href='../../css/uploadify.css' rel='stylesheet'>
    <link href='../../css/animate.min.css' rel='stylesheet'>
    <link rel="stylesheet"  href="../../css/button.css"/>
    <link rel="stylesheet"  href="../../css/commonlist.css"/>    

    <!-- jQuery -->
	<script type="text/javascript" src="../../js/lib/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="../../js/lib/jquery/plugins/jquery.string.js"></script>
	<script type="text/javascript" src="../../js/lib/jquery/plugins/jquery.json.js"></script>
	<script type="text/javascript" src="../../js/lib/easyui/plugins/jquery.draggable.js"></script>
	<script type="text/javascript" src="../../js/lib/easyui/plugins/jquery.parser.js"></script>
    <script type="text/javascript" src="../../../js/peripheral.js"></script>
	<script type="text/javascript" src="../../js/map.js"></script>
	<script type="text/javascript" src="../../js/multiselect.js"></script>
	<script type="text/javascript" src="../../js/multiselect.min.js"></script>
	<script type="text/javascript" src="../../js/prettify.min.js"></script>
 
    <!-- The fav icon -->
    <link rel="shortcut icon" href="../../images/favicon.ico">

</head>
<body>
	<div id="loading1">
		<div>
			<image src='../../js/lib/easyui/themes/default/images/loading.gif' />  正在处理，请稍等...
		</div>
	</div>
	<div id="loading2">
		<div>
			<image src='../../js/lib/easyui/themes/default/images/loading.gif' />  正在刷新，请稍等...
		</div>
	</div>
<div class="ch-container" id="container" style="display: none;">
	<ul id="myTab" class="nav nav-tabs">
	    <li class="active">
	        <a href="#home" data-toggle="tab">排队客户管理</a>
	    </li>
	    <li><a href="#cardTypeDiv" data-toggle="tab">排队策略实时调整</a></li>
    </ul>    
<div id="myTabContent" class="tab-content">
	<div class="tab-pane fade in active" id="home">
    <div class="row">
        
        <noscript>
            <div class="alert alert-block col-md-12">
                <h4 class="alert-heading">Warning!</h4>

               <!-- <p>You need to have <a href="http://en.wikipedia.org/wiki/JavaScript" target="_blank">JavaScript</a>
                    enabled to use this site.</p>-->
            </div>
        </noscript>

        <div id="content" class="col-lg-12 col-sm-12">
            <!-- content starts -->

	<div class="row">
        <div class="box col-md-12">
            <div class="box-inner">
                <div class="box-header well" data-original-title="">
                    <h2><i class="glyphicon glyphicon-info-sign"></i>排队客户管理</h2>

                    <div class="box-icon">
                        <a href="#" class="btn btn-minimize btn-round btn-default"><i
                                class="glyphicon glyphicon-chevron-up"></i></a>
                    </div>
                </div>
                <div class="box-content">						
					<table class="table table-striped table-bordered responsive" id="ccc">
                        <thead>
                        <tr>
							<th style="width:5%;">序号</th>
							<th style="width:14%;">客户号码</th>
                            <th style="width:14%;">客户姓名</th>
                            <th style="width:14%;">客户所办业务</th>
                            <th style="width:14%;">客户取号时间</th>
                            <th style="width:14%;">客户服务状态</th>
                            <th style="width:14%;">客户等待时间</th>
                            <th style="width:11%;">操作</th>
                        </tr>
                        </thead>
                        <tbody>						
							
                        </tbody>
                   </table>
                </div>
            </div>
        </div>
        <!--/span-->
    </div><!--/row-->
	
	
    <!-- content ends -->
    </div><!--/#content.col-md-0-->
</div><!--/fluid-row-->

    <footer class="row">
    </footer>
</div>

<div class="tab-pane fade" id="cardTypeDiv" >
    <div class="row">
        
        <noscript>
            <div class="alert alert-block col-md-12">
                <h4 class="alert-heading">Warning!</h4>

               <!-- <p>You need to have <a href="http://en.wikipedia.org/wiki/JavaScript" target="_blank">JavaScript</a>
                    enabled to use this site.</p>-->
            </div>
        </noscript>

        <div id="content" class="col-lg-12 col-sm-12">
            <!-- content starts -->

	<div class="row">
        <div class="box col-md-12">
            <div class="box-inner">
                <div class="box-header well" data-original-title="">
                    <h2><i class="glyphicon glyphicon-info-sign"></i>排队策略实时调整</h2>

                    <div class="box-icon">
                        <a href="#" class="btn btn-minimize btn-round btn-default"><i
                                class="glyphicon glyphicon-chevron-up"></i></a>
                    </div>
                </div>
                <div class="box-content queue-adjust">
                	<div class="refresh"><a class="btn btn-primary btn-custom refresh" href="#" onclick="refreshHtml()">刷新页面</a></div>
					<table class="table table-striped table-bordered responsive" id="ddd">
                        <thead>
                        <tr>
							<th style="width:10%;">窗口编码</th>
							<th style="width:10%;">窗口编号</th>
							<th style="width:10%;">队列编码</th>
                            <th style="width:10%;">等待叫号个数</th>
                            <th style="width:15%;">当前服务号码</th>
                            <th style="width:15%;">最大服务号码</th>
                            <th style="width:30%;">操作</th>
                        </tr>
                        </thead>
                        <tbody>						
							
                        </tbody>
                   </table>
                </div>
            </div>
        </div>
        <!--/span-->
    </div><!--/row-->
	
	
    <!-- content ends -->
    </div><!--/#content.col-md-0-->
</div><!--/fluid-row-->

	<div class="modal fade" id="myModal1" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 id="modalTitle1" class="modal-title">窗口队列调整</h4>
          </div>
          <form id="frm1" name="frm1" method="post" action="">
          <div class="modal-body">
              <table style="width: 100%">
                <tbody>
		              <tr>
		                <td style="text-align: right; width: 20%">
							窗口编号
		                </td>
		                <td>
		                	<input class="form-control" name="winCode" id="winCode" disabled="disabled">
		                </td>
		              </tr>
		              <tr style="display: ;">
		                <td style="text-align: right; width: 20%" >
							窗口编号<em>*</em>
		                </td>
		                <td>
		                	<input class="form-control" name="winNo" id="winNo" maxlength="500">                  	
		                </td>
		              </tr>
		              <tr>
		                <td style="text-align: right; width: 20%">
							窗口名称
		                </td>
		                <td>
		                	<input class="form-control" name="winName" id="winName" disabled="disabled">                  	
		                </td>
		              </tr>
		              <tr>
		                <td style="text-align: right; width: 20%">
							调整窗口<em>*</em>
		                </td>
		                <td>
		                	<select name="newWinNo" id="newWinNo" validate="{required:false}">
		                    </select>               	
		                </td>
		              </tr>
		              <tr>
		                <td style="text-align: right; width: 20%">
							业务类型<br />排队星级
		                </td>
		                <td>
		                	<textarea name="attr" id="attr" rows="" cols="" disabled="disabled" style="height:200px;width:60%;background-color:#2077a4;border:1px solid #3c9ec3;overflow: auto;scrollbar-face-color: black;"></textarea>                 	
		                </td>
		              </tr>
		              <tr>
		                <td style="text-align: right; width: 20%">
							队列编号
		                </td>
		                <td>
		                	<input class="form-control" name="queueNo" id="queueNo" disabled="disabled">                  	
		                </td>
		              </tr>
		              <tr>
		                <td style="text-align: right; width: 20%">
							队列名称
		                </td>
		                <td>
		                	<input class="form-control" name="queueName" id="queueName" disabled="disabled">                  	
		                </td>
		              </tr>
		              <tr>
		                <td style="text-align: right; width: 20%">
							队列归属<em>*</em>
		                </td>
		                <td>
		                	<select name="locate" id="locate" validate="{required:false}" onchange="locateChange(this)" >
		                      	<option value="1">优先队列</option>
		                      	<option value="2">普通队列</option>
		                      	<option value="3">延后队列</option>
		                    </select>           	
		                </td>
		              </tr>
		              <tr>
		                <td style="text-align: right; width: 20%">
							队列顺序号<em>*</em>
		                </td>
		                <td>
		                	<input class="form-control" name="queueOrd" id="queueOrd" disabled="disabled" placeholder="请输入队列顺序号">                  	
		                </td>
		              </tr>
		              <tr>
		                <td style="text-align: right; width: 20%">
							队列策略<em>*</em>
		                </td>
		                <td>
		                	<input class="form-control" name="queueStrategy" id="queueStrategy" disabled="disabled">                  	
		                </td>
		              </tr>
		              <tr>
		                <td id="selectStrategy" style="text-align: right; width: 20%">
		                </td>
		                <td>
		                	<input class="form-control" name="num" id="num" placeholder="请输入">                  	
		                </td>
		              </tr>
		              <tr style="display: none;">
		                <td style="text-align: right; width: 20%">
							排队机编号<em>*</em>
		                </td>
		                <td>
		                	<input class="form-control" name="qmsNo" id="qmsNo" disabled="disabled">                  	
		                </td>
		              </tr>
                </tbody>
              </table>
          </div>
          <div class="modal-footer">
            <input type="hidden" id="actionType1" />
            <input type="button" class="btn btn-default" data-dismiss="modal" value="取消">
            <input type="submit" class="btn btn-primary" value="确定">
          </div>
          </form>
        </div>
      </div>
    </div>
    
<div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 id="modalTitle1" class="modal-title">队列属性调整</h4>
          </div>
          <form id="frm2" name="frm2" method="post" action="">
          <div class="modal-body">
              <table style="width: 100%">
                <tbody>
                 	<tr>
		                <td style="text-align: right; width: 20%">
							当前窗口编号
		                </td>
		                <td>
		                	<input class="form-control" name="oldWinNo" id="oldWinNo" disabled="disabled">                  	
		                </td>
		            </tr>
		            <tr>
		                <td style="text-align: right; width: 20%">
							调整后窗口编号<em>*</em>
		                </td>
		                <td>
			                <select name="newWinC" id="newWinC" onchange="changeWindow()" validate="{required:false}"  >
		                      	
	                        </select>                  	
		                </td>
		            </tr>
		            <tr>
		                <td style="text-align: right; width: 20%">
							当前队列编码
		                </td>
		                <td>
		                	<input class="form-control" name="oldQueueCode" id="oldQueueCode" disabled="disabled">                  	
		                </td>
		            </tr>
		            <tr style="display: none;">
		                <td style="text-align: right; width: 20%">
							当前队列编号
		                </td>
		                <td>
		                	<input class="form-control" name="oldQueueNo" id="oldQueueNo" disabled="disabled">                  	
		                </td>
		            </tr>
		            <tr>
		                <td style="text-align: right; width: 20%">
							调整后队列编号<em>*</em>
		                </td>
		                <td>
			                <select name="newQueueNo" id="newQueueNo" onchange="showMultiselect_to()" validate="{required:false}"  >
		                      	
	                        </select>                  	
		                </td>
		            </tr>
		            <tr>
		            	<td style="text-align: right; width: 20%">
							业务类型<br />排队星级
		                </td>
		            	<td>
						    <div class="row selelectRow">
						    	<div class="col-xs-5" >
						    		<select name="from" id="multiselect" class="form-control" size="8" multiple="multiple">
						    		</select>
						    	</div>
						    	
						    	<div class="col-xs-2">
						    		<button type="button" id="multiselect_rightAll" >全部右移</button>
						    		<button type="button" id="multiselect_rightSelected" >右移</button>
						    		<button type="button" id="multiselect_leftSelected" >左移</button>
						    		<button type="button" id="multiselect_leftAll" >全部左移</button>
						    	</div>
						    	
						    	<div class="col-xs-5">
						    		<select name="to" id="multiselect_to" class="form-control" size="8" multiple="multiple"></select>
						    	</div>
						    </div>		            		
		            	</td>
		            </tr>
		            <tr style="display: none;">
		                <td style="text-align: right; width: 20%">
							最后修改人<em>*</em>
		                </td>
		                <td>
			                <input class="form-control" name="lstModUser" id="lstModUser" maxlength="500">                	
		                </td>
		            </tr>
                </tbody>
              </table>
          </div>
          <div class="modal-footer">
            <input type="hidden" id="actionType1" />
            <input type="button" class="btn btn-default" data-dismiss="modal" value="取消">
            <input type="submit" class="btn btn-primary" value="确定">
          </div>
          </form>
        </div>
      </div>
    </div>

    <footer class="row">
    </footer>
</div>

</div>
</div><!--/.fluid-container-->

<!-- external javascript -->

<script src="../../js/bootstrap.min.js"></script>

<!-- library for cookie management -->
<script src="../../js/jquery.cookie.js"></script>
<!-- data table plugin -->
<script src='../../js/jquery.dataTables.min.js'></script>

<!-- select or dropdown enhancer -->
<script src="../../js/chosen.jquery.min.js"></script>
<!-- plugin for gallery image view -->
<script src="../../js/jquery.colorbox-min.js"></script>
<!-- notification plugin -->
<script src="../../js/jquery.noty.js"></script>
<!-- library for making tables responsive -->
<script src="../../js/responsive-tables.js"></script>
<!-- tour plugin -->
<script src="../../js/bootstrap-tour.min.js"></script>
<!-- star rating plugin -->
<script src="../../js/jquery.raty.min.js"></script>
<!-- for iOS style toggle switch -->
<script src="../../js/jquery.iphone.toggle.js"></script>
<!-- autogrowing textarea plugin -->
<script src="../../js/jquery.autogrow-textarea.js"></script>
<!-- multiple file upload plugin -->
<script src="../../js/jquery.uploadify-3.1.min.js"></script>
<!-- history.js for cross-browser state change on ajax -->
<script src="../../js/jquery.history.js"></script>
<!-- application script for Charisma demo -->
<script src="../../js/charisma.js"></script>
<script type="text/javascript" src="../../js/jquery.metadata.js"></script>
<script type="text/javascript" src="../../js/jquery.validate.js"></script>
<script type="text/javascript" src="../../js/qmsVld.js"></script>
<script type="text/javascript" src="../../js/bootbox.js"></script>

<script type="text/javascript">
	var $qmsIp = $.qms.getCache("qmsIp");
	var $myModal1 = $("#myModal1");
	var $myModal2 = $("#myModal2");
	var $rowNum = 0;
    var $rowNum1 = 0;
	var $newWinCode = new Array();
	var $busiNameAndLevel = new Array();
	var winCopy = new Array();
	var difPcFlag = new Array();
    var $actionType = $("#actionType");
    var allQueueList = new Array();
    var sameWin = new Array();
    var queueNoQueueCode = new Array();
    
	$(function (){
		initPageWinQue();
		setTimeout(function(){
			initPage();
		},800);
		$('#multiselect').multiselect();
	});

	//--------------------------------------------------------------------------------------------
    //刷新页面
    function refreshHtml(){
    	$("#loading2").css("display","block");
    	$("#container").css("opacity","0.3");
    	initPageWinQue();
    }
//排队客户管理--------------------------------------------------------------------------------------------
    //排队客户管理查询
    function initPage()
    {
      $rowNum = 0;
      $("#ccc tbody").empty().html("");    	

	  var args = {};
	  args.biom = {};
	  args.biom.head = {};
	  args.biom.head.tradeCode = "LocalNumberQuery";
	  args.biom.head.qmsIp = $qmsIp;//;
	  args.biom.body = {};	
	  args.command=34;	
	  args.callback="getLocalNumberQueryCallBack";
	  //alert($.toJSON(args));
	  $.icbcQms.localNumberQuery2JS(args);
	}
    function getLocalNumberQueryCallBack(args){
    	//alert($.toJSON(args));
    	closeLoading();
    	$("#container").css("display","block");
	    var jo = $.parseJSON(args);    	
		var retCode = jo.biom.head.retCode;
		var retMsg = jo.biom.head.retMsg;		
		if(retCode == "0"){				
			$.each(jo.biom.body.localnumberList.localnumberRecord, function (index, item){
				initData(item);
			});		
		}else{
			//跳转错误页面
			window.location.href = "timeout.html?retMsg="+retMsg;		
		}    	
    }
	function initData(itemData)
	{
		//取到最大序号+1
		$tbody = $("#ccc tbody");
		if($tbody.find("tr:last")){
			var num = $tbody.find("tr:last").find("td").eq(0).text();
			if(num){
				$rowNum = num;
			}
		}
		
		$rowNum++;
		var $tr;
		if(itemData){
			if(itemData.custServStatus == "1"){
				$tr = $("<tr>"+
				"<td>"+$rowNum+"</td>"+
				"<td><div class=\"controls\">"+itemData.custNo+"</div></td>"+
				"<td><div class=\"controls\">"+itemData.custName+"</div></td>"+
				"<td><div class=\"controls\">"+itemData.custBusi+"</div></td>"+
				"<td><div class=\"controls\">"+itemData.getTime+"</div></td>"+
				"<td><div class=\"controls\">"+getCustServStatus(itemData.custServStatus)+"</div></td>"+
				"<td><div class=\"controls\">"+itemData.custWaitTime+"</div></td>"+
//				"<td class=\"center\"><a class=\"btn btn-primary\" href=\"#\" onclick='delTr(this);'><i class=\"glyphicon glyphicon-trash icon-white\"></i>删除废号</a></td>"+
				"<td><button class=\"btn btn-primary\"><i class=\"glyphicon glyphicon-trash icon-white\"></i>删除废号</button></td>"+
			"</tr>");
			}else{
				$tr = $("");
			}
		}
		$tr.data("itemData",itemData);
		$tr.appendTo($tbody);
		
		$tbody.find("button:last").on("click",function(){
			delTr(this);
		});
	}
	//删除废号
	function delTr(obj){
		bootbox.setLocale("zh_CN");
      	bootbox.confirm("确定删除?", function(result) {
	        if (result) {  
		    	var $tr = $(obj).parent().parent();
		        var args = {};
				args.biom = {};
				args.biom.head = {};
				args.biom.head.tradeCode = "DeleteabolishNumber";
				args.biom.head.qmsIp = $qmsIp;
				args.biom.body = {};
				args.biom.body.queCustNo = $tr.data("itemData").custNo;
		        args.callback="removeAbolishNumberCallBack";	
				args.command=32;			
		        $.icbcQms.localcardbin2JS(args); 
	        }  
      	});
	}
	function removeAbolishNumberCallBack(args)
    {
		var joResult = $.parseJSON(args);
		var retCode = joResult.biom.head.retCode;
		var retMsg = joResult.biom.head.retMsg;
		if(joResult){
			if(retCode == 0){
			  qmsVld.showInfo(retMsg);
			  initPage();
			}else{
			  qmsVld.showError(retMsg?retMsg:"删除废号失败");
			}				
		}  
    } 
    //客户服务状态
	function getCustServStatus(value){
		var result = "";
		if(value == "1"){
			result = "取号完成等待叫号";
		}else if(value == "2"){
			result = "叫号完成正在办理";
		}else if(value == "3"){
			result = "废弃";
		}	
		return result;
	}
//排队策略实时调整--------------------------------------------------------------------------------------------
	//队列查询
    function initPageWinQue()
    {
      $rowNum1 = 0;
      $("#ddd tbody").empty().html("");    	

	  var args = {};
	  args.biom = {};
	  args.biom.head = {};
	  args.biom.head.tradeCode = "queuequery";
	  args.biom.head.qmsIp = $qmsIp;//;
	  args.biom.body = {};	
	  args.command=34;	
	  args.callback="getqueuequeryCallBack";
	  //alert($.toJSON(args));
	  $.icbcQms.queuequery2JS(args);
	}
    function getqueuequeryCallBack(args){
    	//alert($.toJSON(args));
    	closeLoading();
    	$("#container").css("opacity","1");
    	$("#loading2").css("display","none");
    	$("#container").css("display","block");
    	//清空数组
    	$busiNameAndLevel = [];
    	winCopy = [];
    	difPcFlag = [];
    	allQueueList = [];
    	sameWin = [];
    	$newWinCode = [];
    	queueNoQueueCode = [];
    	
	    var jo = $.parseJSON(args);    	
		var retCode = jo.biom.head.retCode;
		var retMsg = jo.biom.head.retMsg;		
		if(retCode == "0"){				
			$.each(jo.biom.body.record.detail, function (index, item){
				initDataQueue(item);
			});
			$.each(jo.biom.body.queList.queRecord, function (i,n){
				$busiNameAndLevel.push(n.queueNo+"|"+n.busiName+"|"+n.servelevel+"|"+n.busiNo);
				//alert(n.busiName);
			});
			$.each(jo.biom.body.winList.win,function(i,n){
				winCopy.push(n.winNo+"|"+n.pqueueOrd+"|"+n.queueOrd+"|"+n.lqueueOrd);
			})
			$.each(jo.biom.body.queList.queRecord,function(i,n){
				difPcFlag.push(n.pcflag+"|"+n.queueNo);
			})
			$.each(jo.biom.body.queueList.queue,function(i,n){
				allQueueList.push(n.queueNo+"|"+n.queueCode);
			})
			$.each(jo.biom.body.record.detail,function(i,n){
				sameWin.push(n.winNo+"|"+n.queueNo);
			})
		}else{
			//跳转错误页面
			window.location.href = "timeout.html?retMsg="+retMsg;
		}    	
    }
	//初始化排队策略实时调整列表数据
	function initDataQueue(itemData)
	{
		$newWinCode.push(itemData.winNo+"|"+itemData.queueCode);
		queueNoQueueCode.push(itemData.queueNo+"|"+itemData.queueCode);
		//取到最大序号+1
		$tbody = $("#ddd tbody");
		if($tbody.find("tr:last")){
			var num = $tbody.find("tr:last").find("td").eq(0).text();
			if(num){
				$rowNum1 = num;
			}
		}
		$rowNum1++;
		if(itemData){
				$tr = $("<tr>"+
				"<td><div class=\"controls\">"+itemData.winCode+"</div></td>"+
				"<td><div class=\"controls\">"+itemData.winNo+"</div></td>"+
				"<td><div class=\"controls\">"+itemData.queueCode+"</div></td>"+
				"<td><div class=\"controls\">"+itemData.waitNum+"</div></td>"+
				"<td><div class=\"controls\">"+itemData.curSeq+"</div></td>"+
				"<td><div class=\"controls\">"+itemData.maxSeq+"</div></td>"+
//				"<td class=\"center\"><a class=\"btn btn-primary btn-custom\" href=\"#\" onclick=\"onWinQue(this);\"><i class=\"glyphicon glyphicon-edit icon-white\"></i>窗口队列调整</a>"+
//				"<a class=\"btn btn-primary btn-custom\" href=\"#\" onclick='onQueue(this);'><i class=\"glyphicon glyphicon-edit icon-white\"></i>队列属性调整</a></td>"+
				"<td><button class=\"btn btn-primary btn-winQueue\"><i class=\"glyphicon glyphicon-edit icon-white\"></i>窗口队列调整</button>"+
				"<button class=\"btn btn-primary btn-winQueue\"><i class=\"glyphicon glyphicon-edit icon-white\"></i>队列属性调整</button></td>"+
				"</tr>");
		}
		$tr.data("itemData",itemData);
		$tr.appendTo($tbody);
		
		$tbody.find("button:last").prev().on("click",function(){
			onWinQue(this);
		});
		$tbody.find("button:last").on("click",function(){
			onQueue(this);
		});
	}

	//窗口队列调整弹框
	function onWinQue(obj)
    {
      //window.event.stopPropagation();
      var $tr = $(obj).parent().parent();
      showModalWin($tr.data("itemData"));
    }
    function showModalWin(itemData){
    	//清空textarea内容
    	$("#attr").empty();
    	$("#winNo").val("");
    	$("#winCode").val("");
    	$("#winName").val("");
    	$("#queueNo").val("");
    	$("#queueName").val("");
    	$("#newWinNo").empty();
    	$("#queueOrd").val("");
    	$("#queueStrategy").val("");
    	$("#num").val("");
    	$("#selectStrategy").empty();
    	$("#qmsNo").val("");
    	
    	$("#winNo").val(itemData.winNo);
    	$("#winCode").val(itemData.winCode);
    	$("#winName").val(itemData.winName);
    	$("#queueNo").val(itemData.queueNo);
    	$("#queueName").val(itemData.queueName);
    	$("#num").val(itemData.num);
    	
    	var attr = itemData.attr.split("；");
    	$.each(attr, function(i,n) {
    		$("<span>"+n+"</span><br/>").appendTo($("#attr"))
    	});
    	//调整窗口选项
    	var allWin = new Array();//全部窗口编号
    	for (var i=0;i<winCopy.length;i++) {
    		var winTemp = new Array();
    		winTemp = winCopy[i].split("|");
    		allWin.push(winTemp[0]);
    	}
    	//alert(allWin);
		var anotherWin = new Array();//与本窗口队列编码相同的窗口编号
		for(var i=0;i<$newWinCode.length;i++){
			if($newWinCode[i].indexOf(itemData.queueCode) != -1){
				var otherWinTemp = new Array();
				otherWinTemp = $newWinCode[i].split("|");
				anotherWin.push(otherWinTemp[0]);
			}
		}
		//alert(anotherWin);
		//取差集
		var newResult = new Array();//获得调整窗口的编号
		for(var i=0; i < allWin.length; i++){   
		    var flag = true;   
		    for(var j=0; j < anotherWin.length; j++){   
		        if(allWin[i] == anotherWin[j])   
		        flag = false;   
		    }   
		    if(flag)   
		    newResult.push(allWin[i]);   
		}
		//alert(newResult);
    	$.each(newResult, function(i,n) {
      		$("<option>"+n+"</option>").appendTo($("#newWinNo"));
    	});
    	//调整窗口选项----end
    	
    	$("#newWinNo").data("WinMes",itemData);
    	funAdjustWin(itemData);
    	$("#newWinNo").trigger("chosen:updated");
    	$("#newWinNo").chosen(); 
		$("#newWinNo").next().css("width","60%");
		
    	$("#locate").trigger("chosen:updated");
		$("#locate").chosen(); 
		$("#locate").next().css("width","60%");
		$("#qmsNo").val(itemData.qmsNo);
    	$myModal1.modal("show");
    }
    
    //队列归属调整
    function locateChange(obj){
    	var $tr = $("#newWinNo");
        funAdjustWin($tr.data("WinMes"));
    }
    function funAdjustWin(itemData){
    	$("#queueOrd").val("");
    	var newWinNoTemp = $.trim($("#newWinNo").val());
    	if($("#locate").val() == 1){
    		var newWin = new Array();
    		for(var i=0;i<winCopy.length;i++){
    			if(winCopy[i].indexOf(newWinNoTemp) != -1){
    				newWin = winCopy[i];
    			}
    		}
    		var newWinTemp = newWin.split("|");
    		$("#queueOrd").val( parseInt(newWinTemp[1])+1);
    		showStrategy(itemData.pQueueTac);
    		selectStrategy(itemData.pQueueTac);
    	};
    	if($("#locate").val() == 2){
    		var newWin = new Array();
    		for(var i=0;i<winCopy.length;i++){
    			if(winCopy[i].indexOf(newWinNoTemp) != -1){
    				newWin = winCopy[i];
    			}
    		}
    		var newWinTemp = newWin.split("|");
    		$("#queueOrd").val( parseInt(newWinTemp[2])+1);
    		showStrategy(itemData.queueTac);
    		selectStrategy(itemData.queueTac);
    	};
    	if($("#locate").val() == 3){
    		var newWin = new Array();
    		for(var i=0;i<winCopy.length;i++){
    			if(winCopy[i].indexOf(newWinNoTemp) != -1){
    				newWin = winCopy[i];
    			}
    		}
    		var newWinTemp = newWin.split("|");
    		$("#queueOrd").val( parseInt(newWinTemp[3])+1);
    		showStrategy(itemData.lQueueTac);
    		selectStrategy(itemData.lQueueTac);
    	}
    };
	function showStrategy(Tac){
		$("#queueStrategy").val("");
		switch(parseInt(Tac)){
			case 1:
				$("#queueStrategy").val("按照超时时间");
				break;
			case 2:
				$("#queueStrategy").val("按照叫号个数");
				break;
			case 3:
				$("#queueStrategy").val("按照队列叫号");
				break;
			case 4:
				$("#queueStrategy").val("按照等待时间");
				break;
			case 5:
				$("#queueStrategy").val("按照延时比例叫号");
				break;
			default:
				$("#queueStrategy").val("按照叫号个数");
		}
	}
	function selectStrategy(Tac){
		$("#selectStrategy").html("");
		switch(parseInt(Tac)){
			case 1:
				$("#selectStrategy").parent().css("display","block");
				$("#selectStrategy").html("超时时间<em>*</em>");
				break;
			case 2:
				$("#selectStrategy").parent().css("display","block");
				$("#selectStrategy").html("叫号个数<em>*</em>");
				break;
			case 5:
				$("#selectStrategy").parent().css("display","block");
				$("#selectStrategy").html("连续叫号个数<em>*</em>");
				break;
			default:
				$("#selectStrategy").parent().css("display","none");
		}
	}
    
    //队列属性调整弹框
	function onQueue(obj)
    {
      var $tr = $(obj).parent().parent();
      showModalQue($tr.data("itemData"));
    }
    function showModalQue(itemData){
    	$("#oldWinNo").val("");
    	$("#newWinC").empty();
    	$("#newQueueNo").empty();
    	$("#oldQueueNo").val("");
    	$("#oldQueueCode").val("");
    	$("#multiselect").empty();
    	$("#multiselect_to").empty();
    	
    	$("#oldWinNo").val(itemData.winNo);
    	$("#oldQueueCode").val(itemData.queueCode);
    	$("#oldQueueNo").val(itemData.queueNo);
    	
		//调整后窗口编号
		$.each(winCopy, function(i,n) {
			var newAdjustWin = new Array();
			var AdjustWinTemp = new Array();
			AdjustWinTemp = n.split("|");
			if(itemData.winNo != AdjustWinTemp[0]){
				$("<option>"+AdjustWinTemp[0]+"</option>").appendTo($("#newWinC"));
			}
		});

		//调整后队列编号
		var result = new Array();
		result = adjustQueueCode($("#newWinC").val(),itemData.queueNo);
		//alert(result);
		$.each(result, function(i,n) {
			var thrTemp = "";
			$.each(queueNoQueueCode, function(k,j) {
				var oneTemp = j.split("|");
				var twoTemp = oneTemp.indexOf(n);
				if(twoTemp != -1){
					thrTemp = oneTemp[1];
				}
			});
			$("<option>"+thrTemp+"</option>").appendTo($("#newQueueNo"));
		});
		
		//业务类型，排队星级(左)
    	$.each($busiNameAndLevel, function(i,n){
    		var busiNameAndLevelTemp = new Array();
			busiNameAndLevelTemp = n.split("|");
    		if(parseInt(busiNameAndLevelTemp[0]) == itemData.queueNo){
    			var levelTemp = "";
    			if(busiNameAndLevelTemp[2] == 0){
    				levelTemp = "三星级以下";
    			}else if(busiNameAndLevelTemp[2] == 1){
    				levelTemp = "三星级以下";
    			}else if(busiNameAndLevelTemp[2] == 2){
    				levelTemp = "三星级以下";
    			}else if(busiNameAndLevelTemp[2] == 3){
    				levelTemp = "三星级";
    			}else if(busiNameAndLevelTemp[2] == 4){
    				levelTemp = "四星级";
    			}else if(busiNameAndLevelTemp[2] == 5){
    				levelTemp = "五星级";
    			}else if(busiNameAndLevelTemp[2] == 6){
    				levelTemp = "六星级";
    			}else if(busiNameAndLevelTemp[2] == 7){
    				levelTemp = "七星级";
    			}else if(busiNameAndLevelTemp[2] == 8){
    				levelTemp = "八星级";
    			}else if(busiNameAndLevelTemp[2] == 9){
    				levelTemp = "九星级";
    			}
    			$("<option selected='selected'>"+busiNameAndLevelTemp[1]+","+busiNameAndLevelTemp[3]+","+levelTemp+"</option>").appendTo($("#multiselect"));
    		}
    	});
    	//业务类型，排队星级(右)
    	$.each($busiNameAndLevel, function(i,n){
    		var queueCodeTempOne = $("#newQueueNo").val();
    		var newArrayTemp = new Array();
    		for (var i=0;i<allQueueList.length;i++) {
    			if(allQueueList[i].indexOf(queueCodeTempOne) != -1){
    				newArrayTemp = allQueueList[i].split("|");
    			}
    		}
    		var queueNoTemp = newArrayTemp[0];
    		var busiNameAndLevelTemp = new Array();
			busiNameAndLevelTemp = n.split("|");
    		if(parseInt(busiNameAndLevelTemp[0]) == queueNoTemp){
    			var levelTemp = "";
    			if(busiNameAndLevelTemp[2] == 0){
    				levelTemp = "三星级以下";
    			}else if(busiNameAndLevelTemp[2] == 1){
    				levelTemp = "三星级以下";
    			}else if(busiNameAndLevelTemp[2] == 2){
    				levelTemp = "三星级以下";
    			}else if(busiNameAndLevelTemp[2] == 3){
    				levelTemp = "三星级";
    			}else if(busiNameAndLevelTemp[2] == 4){
    				levelTemp = "四星级";
    			}else if(busiNameAndLevelTemp[2] == 5){
    				levelTemp = "五星级";
    			}else if(busiNameAndLevelTemp[2] == 6){
    				levelTemp = "六星级";
    			}else if(busiNameAndLevelTemp[2] == 7){
    				levelTemp = "七星级";
    			}else if(busiNameAndLevelTemp[2] == 8){
    				levelTemp = "八星级";
    			}else if(busiNameAndLevelTemp[2] == 9){
    				levelTemp = "九星级";
    			}
    			$("<option selected='selected'>"+busiNameAndLevelTemp[1]+","+busiNameAndLevelTemp[3]+","+levelTemp+"</option>").appendTo($("#multiselect_to"));
    		}
    	});
    	
		$("#newWinC").trigger("chosen:updated");
		$("#newWinC").chosen(); 
		$("#newWinC").next().css("width","60%");
		$("#newQueueNo").trigger("chosen:updated");
		$("#newQueueNo").chosen(); 
		$("#newQueueNo").next().css("width","60%");
    	$myModal2.modal("show");
    }
    
    function adjustQueueCode(winCodeParam,queueCodeParam){   	
    	var NewDifPcFlag = [];
		var json = {};
		for (var i=0;i<difPcFlag.length;i++) {
			if(!json[difPcFlag[i]]){
				NewDifPcFlag.push(difPcFlag[i]);
				json[difPcFlag[i]] =1;
			}
		}
		var newSameWin = new Array();
		$.each(sameWin, function(i,n) {
			var sameWinTemp =new Array();
			sameWinTemp = n.split("|");
			if(sameWinTemp[0] == winCodeParam && sameWinTemp[1] != queueCodeParam){
				newSameWin.push(n);
			}
		});
		//alert(newSameWin);
		
		var twoQueCode = new Array();
		$.each(newSameWin, function(i,n) {
			var newSameWinTemp =new Array();
			newSameWinTemp = n.split("|");
			twoQueCode.push(newSameWinTemp[1]);
		});
		//alert(twoQueCode);
		
		var pcflag =0;
		$.each(NewDifPcFlag, function(i,n) {
			if(n.indexOf(queueCodeParam)!=-1){
				var nTemp = new Array();
				nTemp = n.split("|");
				pcflag = nTemp[0]
			}
		});
		var pcflatList = new Array();
		$.each(NewDifPcFlag, function(i,n) {
			var mmm = new Array();
			mmm = n.split("|");
			if(n[0].indexOf(pcflag)!=-1){
				pcflatList.push(n);
			}
		});
		//alert(pcflatList);
		
		var thrQueCode = new Array();
		$.each(pcflatList, function(i,n) {
			var thrQueCodeTemp = new Array();
			thrQueCodeTemp = n.split("|");
			thrQueCode.push(thrQueCodeTemp[1]);
		});
		//alert(thrQueCode);
		
		var ai=0, bi=0;
		var result = new Array();
		while( ai < twoQueCode.length && bi < thrQueCode.length )
		{
		   if (twoQueCode[ai] < thrQueCode[bi] ){ ai++; }
		   else if (twoQueCode[ai] > thrQueCode[bi] ){ bi++; }
		   else /* they're equal */
		   {
		    result.push(twoQueCode[ai]);
		    ai++;
		    bi++;
		   }
		}
		return result;
    }
    //队列属性调整中，调整后窗口与调整后队列联动
    function changeWindow(){
    	var winCodeParam = $("#newWinC").val();
    	var queueCodeTemp = $.trim($("#oldQueueNo").val());
    	var queueCodeParam = 0;
    	var newResult = new Array();
		for(var i=0;i<allQueueList.length;i++){
			if(allQueueList[i].indexOf(queueCodeTemp) != -1){
    			var sameWinTemp = new Array();
    			sameWinTemp = allQueueList[i].split("|");
    			queueCodeParam = sameWinTemp[0];
    		}
		}
		$("#newQueueNo").empty();
    	var newResult = adjustQueueCode(winCodeParam,queueCodeParam);
    	$.each(newResult, function(i,n) {
    		var thrTemp = "";
			$.each(queueNoQueueCode, function(k,j) {
				var oneTemp = j.split("|");
				var twoTemp = oneTemp.indexOf(n);
				if(twoTemp != -1){
					thrTemp = oneTemp[1];
				}
			});
			$("<option>"+thrTemp+"</option>").appendTo($("#newQueueNo"));
		});
		$("#newQueueNo").trigger("chosen:updated");
		$("#newQueueNo").chosen(); 
		$("#newQueueNo").next().css("width","60%");
		showMultiselect_to();
    }
    //业务类型排队星级，右框回显
    function showMultiselect_to(){
    	$("#multiselect_to").empty();
    	var queueCodeTempOne = $("#newQueueNo").val();
		$.each($busiNameAndLevel, function(i,n){
    		var newArrayTemp = new Array();
    		for (var i=0;i<allQueueList.length;i++) {
    			if(allQueueList[i].indexOf(queueCodeTempOne) != -1){
    				newArrayTemp = allQueueList[i].split("|");
    			}
    		}
    		var queueNoTemp = newArrayTemp[0];
    		var busiNameAndLevelTemp = new Array();
			busiNameAndLevelTemp = n.split("|");
    		if(parseInt(busiNameAndLevelTemp[0]) == queueNoTemp){
    			var levelTemp = "";
    			if(busiNameAndLevelTemp[2] == 0){
    				levelTemp = "三星级以下";
    			}else if(busiNameAndLevelTemp[2] == 1){
    				levelTemp = "三星级以下";
    			}else if(busiNameAndLevelTemp[2] == 2){
    				levelTemp = "三星级以下";
    			}else if(busiNameAndLevelTemp[2] == 3){
    				levelTemp = "三星级";
    			}else if(busiNameAndLevelTemp[2] == 4){
    				levelTemp = "四星级";
    			}else if(busiNameAndLevelTemp[2] == 5){
    				levelTemp = "五星级";
    			}else if(busiNameAndLevelTemp[2] == 6){
    				levelTemp = "六星级";
    			}else if(busiNameAndLevelTemp[2] == 7){
    				levelTemp = "七星级";
    			}else if(busiNameAndLevelTemp[2] == 8){
    				levelTemp = "八星级";
    			}else if(busiNameAndLevelTemp[2] == 9){
    				levelTemp = "九星级";
    			}
    			$("<option selected='selected'>"+busiNameAndLevelTemp[1]+","+busiNameAndLevelTemp[3]+","+levelTemp+"</option>").appendTo($("#multiselect_to"));
    		}
    	});
    }
    
    //窗口队列提交
	$("#frm1").validate({
		rules: {
			locate:{required:true},
			num:{required:true,num:true},
			lstModiUser:{required:true,byteRangeLength:[0,500]},
		},		
		submitHandler: function(form){
			winSaveConfig();
			return false;
		}
	});	
	function winSaveConfig(){
		$myModal1.modal("hide");
		var branchId = "";
		var zoneNo = "";
		var brNo = "";
		var oldWinNo = $.trim($("#winNo").val());
		var newWinNo =$.trim($("#newWinNo").val());
		var qmsNo = $.trim($("#qmsNo").val());
		var queueNo = $.trim($("#queueNo").val());
		var locate = $.trim($("#locate").val());
		var queueOrd = $.trim($("#queueOrd").val());
		var num = $.trim($("#num").val());
		var lstModiUser = "qms";

		if(newWinNo == ""){
			bootbox.alert("没有可调整窗口!");
			$(".modal-content .modal-footer .btn").text("");
			$(".modal-content .modal-footer .btn").text("确定");
			return;
		};
		
		var args = {};
		args.biom = {};
		args.biom.head = {};
		args.biom.head.tradeCode = "windowQueueAdjust";
		args.biom.head.qmsIp = $qmsIp;//;
		args.biom.body = {};
		args.biom.body.branchId = branchId;
		args.biom.body.zoneNo = zoneNo;
		args.biom.body.brNo = brNo;
		args.biom.body.oldWinNo = oldWinNo;
		args.biom.body.newWinNo = newWinNo;
		args.biom.body.qmsNo = qmsNo;
		args.biom.body.queueNo = queueNo;
		args.biom.body.locate = locate;
		args.biom.body.queueOrd = queueOrd;
		args.biom.body.num = num;
		args.biom.body.lstModiUser = lstModiUser;
		args.callback="windowQueueAdjust2JSupdateCallBack";	
		args.command=33;
		//alert($.toJSON(args));
		$.icbcQms.windowQueueAdjust2JS(args);	
	}
	function windowQueueAdjust2JSupdateCallBack(args){
		//alert(args);
		var joResult = $.parseJSON(args);
		if(joResult){
			if(joResult.biom.head.retCode == 0){
				qmsVld.showInfo("成功");
				initPageWinQue();
			}else{
				qmsVld.showError(joResult.biom.head.retMsg);
			}				
		}
	}
	
	//队列属性提交
	$("#frm2").validate({
		rules: {		
			lstModUser:{required:true,byteRangeLength:[0,500]},
		},		
		submitHandler: function(form){
			queSaveConfig();
			return false;
		}
	});
	function queSaveConfig(){
		$myModal2.modal("hide");
		var oldWinNo =$.trim($("#oldWinNo").val());
		var newWinNo = $.trim($("#newWinC").val());
		var oldQueueNo = $.trim($("#oldQueueNo").val());
		var newQueueNoTemp = $.trim($("#newQueueNo").val());
		var newQueueNo = "";
		$.each(queueNoQueueCode, function(k,j) {
			var oneTemp = j.split("|");
			var twoTemp = oneTemp.indexOf(newQueueNoTemp);
			if(twoTemp != -1){
				newQueueNo = oneTemp[0];
			}
		});
		var lstModiUser = "qms";
		var $multiselect = $("#multiselect option");
		var $multiselect_to = $("#multiselect_to option");
		if(newQueueNoTemp == ""){
			bootbox.alert("没有可调整队列编码!");
			$(".modal-content .modal-footer .btn").text("");
			$(".modal-content .modal-footer .btn").text("确定");
			return;
		};
		if($("#multiselect option").html() == undefined || $("#multiselect_to option").html() == undefined){
			bootbox.alert("调整后队列业务类型和排队星级不能不空!");
			$(".modal-content .modal-footer .btn").text("");
	  		$(".modal-content .modal-footer .btn").text("确定");
			return;
		};

		var args = {};
		args.biom = {};
		args.biom.head = {};
		args.biom.head.tradeCode = "queueAttributesUpdate";
		args.biom.head.qmsIp = $qmsIp;//;
		args.biom.body = {};
		args.biom.body.oldWinNo = oldWinNo;
		args.biom.body.newWinNo = newWinNo;
		args.biom.body.oldQueueNo = oldQueueNo;
		args.biom.body.newQueueNo = newQueueNo;
		args.biom.body.lstModiUser = lstModiUser;
		args.biom.body.oldAttrList = {};
		args.biom.body.oldAttrList.detail = [];
		args.biom.body.newAttrList = {};
		args.biom.body.newAttrList.detail = [];
		$.each($multiselect, function(i,n) {
			var $oldbuslist = $(this).html();
			var oldAttrListTemp = new Array();
			oldAttrListTemp = $oldbuslist.split(",");
			var $oldbusType = oldAttrListTemp[1];
			var $oldseverLevel = oldAttrListTemp[2];
			var detail = {};
			detail.busiTypeNo =$oldbusType;
			if($oldseverLevel == "三星级以下"){
				detail.serveLevel = "0";
			}else if($oldseverLevel == "三星级以下"){
				detail.serveLevel = "1";
			}else if($oldseverLevel == "三星级以下"){
				detail.serveLevel = "2";
			}else if($oldseverLevel == "三星级"){
				detail.serveLevel = "3";
			}else if($oldseverLevel == "四星级"){
				detail.serveLevel = "4";
			}else if($oldseverLevel == "五星级"){
				detail.serveLevel = "5";
			}else if($oldseverLevel == "六星级"){
				detail.serveLevel = "6";
			}else if($oldseverLevel == "七星级"){
				detail.serveLevel = "7";
			}else if($oldseverLevel == "八星级"){
				detail.serveLevel = "8";
			}else{
				detail.serveLevel = "9";
			};
			args.biom.body.oldAttrList.detail.push(detail);
			//alert($.toJSON(detail));
		});
		$.each($multiselect_to, function(i,n) {
			var $newBbusList = $(this).html();
			var newAttrListTemp = new Array();
			newAttrListTemp = $newBbusList.split(",");
			var $newBusType = newAttrListTemp[1];
			var $newSeverLevel = newAttrListTemp[2];
			var detail = {};
			detail.busiTypeNo =$newBusType;
			if($newSeverLevel == "三星级以下"){
				detail.serveLevel = "0";
			}else if($newSeverLevel == "三星级以下"){
				detail.serveLevel = "1";
			}else if($newSeverLevel == "三星级以下"){
				detail.serveLevel = "2";
			}else if($newSeverLevel == "三星级"){
				detail.serveLevel = "3";
			}else if($newSeverLevel == "四星级"){
				detail.serveLevel = "4";
			}else if($newSeverLevel == "五星级"){
				detail.serveLevel = "5";
			}else if($newSeverLevel == "六星级"){
				detail.serveLevel = "6";
			}else if($newSeverLevel == "七星级"){
				detail.serveLevel = "7";
			}else if($newSeverLevel == "八星级"){
				detail.serveLevel = "8";
			}else{
				detail.serveLevel = "9";
			}
			args.biom.body.newAttrList.detail.push(detail);
			//alert($.toJSON(detail));
		});
		args.callback="queueAttributesUpdate2JSCallBack";	
		args.command=33;
		//alert($.toJSON(args));
		$.icbcQms.queueAttributes2JS(args);
	}
	function queueAttributesUpdate2JSCallBack(args){
		//alert(args);
		var joResult = $.parseJSON(args);
		if(joResult){
			if(joResult.biom.head.retCode == 0){
				qmsVld.showInfo("成功");
				initPageWinQue();
			}else{
				qmsVld.showError(joResult.biom.head.retMsg);
			}				
		}
	}

</script>

</body>
</html>
